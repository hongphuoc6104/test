# Face Search

## Installation

Install the project in editable mode:

```bash
pip install -e .
```

## Searching Actors

Use ``utils.search_actor.search_actor`` to compute a face embedding and search
against the index. To retrieve only the embedding along with a search function
for later use:

```python
from utils.search_actor import search_actor

results = search_actor("path/to/image.jpg", return_emb=True)
embedding = results["embedding"]
matches = results["search_func"](embedding)
```

When ``return_emb`` is ``False`` (default), ``search_actor`` directly returns
the top matches.

## Command-line search

Run the search CLI from the terminal:

```bash
python cli/search_cli.py --image path/to/image.jpg \
    --sim-threshold 0.5 \
    --margin-threshold 0.05 \
    --top-k 5 \
    --ratio-threshold 1.1
```

All optional flags default to values in `configs/config.yaml` when not provided.

## Viewing search results

Use the viewer CLI to visualize candidate frames returned from the recognition
service:

```bash
python cli/search_viewer.py --image path/to/image.jpg --top-k 5
```

If the query is recognized, frames are grouped by movie using paths from
`frames_root`. When the face is unknown, the script falls back to nearest
candidates and displays preview images generated by
`tasks/preview_clusters_task.py`.

## Cluster Previews

`tasks/preview_clusters_task.py` tạo các ảnh minh họa cho từng cụm và lưu vào
thư mục được cấu hình tại `storage.cluster_previews_root`. Mỗi
`cluster_<id>` sẽ chứa tối đa 3 khung hình đại diện gồm:

- Ảnh gốc (`*.jpg`)
- Ảnh có vẽ bbox (`*_bbox.jpg`)

Để kiểm tra thủ công chất lượng gom cụm, mở thư mục preview và quan sát các
hình ảnh tương ứng